---
title: "US election"
output: html_document
---
---
categories:
- ""
- ""
date: "2017-10-31T21:28:43-05:00"
description: "US election"
draft: false
image: usa.jpg
keywords: ""
slug: blog9
title: US election
---


```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE, 
  tidy=FALSE,     # display code as typed
  size="small")   # slightly smaller font for code
options(digits = 3)

# default figure size
knitr::opts_chunk$set(
  fig.width=6.75, 
  fig.height=6.75,
  fig.align = "center"
)
```


```{r load-libraries, include=FALSE}
library(tidyverse)  # Load ggplot2, dplyr, and all the other tidyverse packages
library(mosaic)
library(ggthemes)
library(lubridate)
library(here)
library(skimr)
library(janitor)
library(httr)
library(readxl)
library(vroom)
library(infer)
library(patchwork)
library(kableExtra)
library(scales)
```

# Trump's Approval Margins

As we saw in class, fivethirtyeight.com has detailed data on [all polls that track the president's approval ](https://projects.fivethirtyeight.com/trump-approval-ratings)

```{r, cache=TRUE}
# Import approval polls data
approval_polllist <- read_csv(here::here('data', 'approval_polllist.csv'))

# or directly off fivethirtyeight website
# approval_polllist <- read_csv('https://projects.fivethirtyeight.com/trump-approval-data/approval_polllist.csv') 

glimpse(approval_polllist)

# Use `lubridate` to fix dates, as they are given as characters.
approval_polllist_dates <- approval_polllist %>% 
  mutate(enddate = mdy(enddate)) %>% 
  mutate(week_count = week(enddate)) %>% 
  mutate(year = year(enddate))
approval_polllist_dates

```

## Create a plot

You can facet by year, and add an orange line at zero. Your plot should look like this:

```{r trump_margins, echo=FALSE, out.width="100%"}
knitr::include_graphics(here::here("images", "trump_approval_margin.png"), error = FALSE)
```
```{r}
#Keeping only voters as the subgroup 
approval_polllist_dates <-approval_polllist_dates %>% filter(subgroup == "Voters")

#Adding net rate to the data set "approval_polllist_dates"
approval_polllist_dates <- approval_polllist_dates %>% mutate(net_rate = (approve-disapprove)/(approve+disapprove)*100) %>%
  filter(!is.na(net_rate))

#Calculating average net rate on a weekly basis
Weekly_rating <- approval_polllist_dates %>% 
  group_by(year,week_count) %>% 
  summarise(average_weekly_netrate = mean(net_rate),SD = sd(net_rate), SE = SD/sqrt(length(net_rate)), DF = length(net_rate)-1) %>%
  filter(!is.na(SD)) 
  #filter(!is.na(SE)) %>% 
  #filter(!is.na(DF)) %>%
  #filter(!is.na(CI.upper)) %>% 
  #filter(!is.na(CI.lower)) 

#Defining confidence intervals
Weekly_rating <- Weekly_rating %>% mutate(CI.upper = average_weekly_netrate+qt(.975,DF)*SE, CI.lower = average_weekly_netrate-qt(.975,DF)*SE)

#Plotting the data
graph_colouring <- c("#FF7733" ,"#81C813", "#2BEEE7", "#ED80FB")

Weekly_rating %>%
  ggplot(aes(x=week_count, y=average_weekly_netrate, color = factor(year))) + 
  geom_line() +  
  facet_wrap(~year) + 
  geom_hline(yintercept =0, color = "orange") + 
  scale_x_continuous (limits = c(0,52),breaks=c(0,13,26,39,52),labels = c("0", "13","26","39","52"))+ 
  geom_point() +
  scale_y_continuous (limits=c(-22,9),breaks=c(-20,-17.5,-15,-12.5,-10,-7.5,-5,-2.5,0,2.5,5,7.5)) +
  geom_ribbon(aes(ymin = CI.lower, ymax = CI.upper, fill = year), alpha=.2) +
  labs(y= "Average Net Approval (%)", x = "Week of the year") + 
  ggtitle(label = "Estimating Net Approval (approve - dissaprove) for Donald Trump", subtitle = "Weekly average of all polls") +
  theme(title = element_text(size=8),
        #axis.text.y = element_blank(),
        axis.title = element_text(size=8),
        axis.text = element_text(size=8),
        axis.ticks = element_blank(),
        strip.text = element_text(size=8),
        panel.background  = element_rect(color="black", fill = "white"),
        panel.border = element_blank(),
        strip.background = element_rect(color="black", fill="grey", size=.5),
        panel.grid = element_line(color = "#DCDCDC"),
        legend.position = "none") +
  scale_colour_manual(aesthetics = "custom_color_palette")

```